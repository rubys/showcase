<table class="w-full" style="break-before: page">
  <thead>
  <tr>
    <td colspan="7" class="font-bold pt-8 text-3xl pb-5" >
      <%= names.map(&:name).join(' / ') %>
      <span class="font-normal text-base float-right text-right">
        <%= studio %><br>
        <%= @event.name %>
      </span>
    </td>
  </tr>
  <tr>
    <td class="row-head-left">Category</td>
    <td class="row-head-left">Dance</td>
    <td class="row-head-left">Level</td>
    <td class="row-head">Category</td>
    <td class="row-head">Count</td>
    <td class="row-head">Price</td>
  </tr>
  </thead>
  <tbody>
  <% total = count = 0 %>
  <% age_cost = @track_ages ? AgeCost.all.index_by(&:age_id) : {} %>
  <% heats = entries.map(&:heats).flatten %>
  <% heats.sort_by! {|heat| [heat.entry.level_id, heat.entry.age_id, heat.category, heat.dance.name]} %>
  <% heats.group_by {|heat| [heat.category, heat.dance.name, heat.entry.level.name, heat.entry.subject_category(@track_ages)]}.each do |(category, dance, level, subjcat), heats| %>
    <% heat = heats.first
    
       entry = heat.entry
       if entry.lead.type == 'Student' and entry.follow.type == 'Student'
         split = 2
         split = 1 if entry.lead == partner or entry.follow == partner
       elsif entry.lead.type == 'Professional' and entry.follow.type == 'Professional' and
             category == 'Solo' and entry.lead.studio_id != entry.follow.studio_id
         split = 2
       else
         split = 1
       end

       cost_category = category
       cost_category = heat.dance_category.name if heat.dance_category&.cost_override
       cost_category = heat.dance.name if heat.dance.cost_override

       # Use professional cost for professional solos with dancers from different studios
       if entry.lead.type == 'Professional' and entry.follow.type == 'Professional' and
          category == 'Solo' and entry.lead.studio_id != entry.follow.studio_id
         cost = @pcost[cost_category] || 0
       else
         cost = @cost[cost_category] || 0
       end
       cost -= 5 if ENV['RAILS_APP_DB'] == '2024-laval' && entry.age.category.start_with?('J')
       cost = age_cost[entry.age_id].heat_cost || cost if @track_ages && age_cost[entry.age_id]
       %>
    <tr class="text-sm">
      <td><div class="mx-4"><%= category %></div></td>
      <td><div class="mx-4"><%= dance %></div>
      <td><%= level %></td>
      <td class="text-center"><%= subjcat %></td>
      <td class="text-right"><%= number_with_precision heats.length.to_f/split, strip_insignificant_zeros: true %></td>
      <td class="text-right"><%= localized_number cost*heats.length/split %></td>
    </tr>
    <% count += heats.length.to_f/split %>
    <% total += cost/split * heats.length %>
  <% end %>
    <tr class="text-sm">
      <th colspan="4">subtotal</th>
      <th class="text-right"><%= count %></th>
      <th class="text-right"><%= localized_number total %></th>
    </tr>
  </tbody>
</table>
