#!/usr/bin/env bash

if ! command -v foreman &> /dev/null
then
  echo "Installing foreman..."
  gem install foreman
fi

test -e public/assets && bin/rake assets:clobber

if [[ $# -gt 0 ]]; then
  DIR="$( dirname -- "${BASH_SOURCE[0]}"; )";   # Get the directory name
  DIR="$( readlink -f "$DIR"; )";    # Resolve its full path if need be
  BASE="$(realpath $DIR/..)"

  export RAILS_APP_DB=$(basename -s .sqlite3 $1)
  export RAILS_STORAGE=$BASE/storage/$(basename -s .sqlite3 $1)

  if [[ $# -gt 1 ]]; then
    export HTTP_X_REMOTE_USER=$2
  fi

  if [[ "$1" = "test" ]]; then
    export RAILS_ENV=test
    bin/rails db:prepare db:fixtures:load
  elif [[ "$1" = "demo" ]]; then
    rm -f db/demo.sqlite3
    bin/rails db:prepare db:seed
  fi
fi

foreman start -f Procfile.dev
