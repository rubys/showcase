#!/bin/bash

if [ "$1" = "clobber" ]; then
  bin/bundle exec rake prerender:clobber
  exit 0
fi

export RAILS_ENV=production
bin/bundle exec rake prerender > log/prerender.log

input_file="tmp/tenants.list"
lines=()

if [ -f "$input_file" ] && [ -n "$FLY_REGION" ]; then
  while IFS= read -r line; do
    lines+=("$line")
  done < "$input_file"

  if [ ${#lines[@]} -gt 0 ]; then
    ruby bin/prepare.rb "${lines[@]}"
  fi
fi

if [ -n "$FLY_REGION" ]; then
  sleep infinity
fi
