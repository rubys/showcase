<% content_for :head do %>
  <%= stylesheet_link_tag "xterm", "data-turbo-track": "reload" %>
<% end %>

<% user = User.find_by(userid: @authuser) %>

<div class="mx-auto md:w-2/3 w-full" data-controller="submit config-update"
     data-config-update-user-id-value="<%= user&.id %>"
     data-config-update-database-value="<%= ENV['RAILS_APP_DB'] %>"
     data-config-update-redirect-url-value="<%= admin_path %>">

<h1 class="text-4xl font-extrabold text-center">Apply Changes</h1>

<div class="my-4 min-w-full flex flex-col items-center">

<% changes = false %>

<% if @showcases_drift %>
<h2 class="font-bold text-2xl mt-4 mb-2 text-orange-600">⚠️ Git Drift Detected</h2>
<p class="text-sm text-gray-600 mb-2">
  config/tenant/showcases.yml is out of sync with deployed state.
  Full deployment recommended to update git-tracked file.
</p>
<% changes = true %>
<% end %>

<% unless `rsync -i --dry-run db/index.sqlite3 smooth:/data/db/`.empty? %>
<h2 class="font-bold text-2xl mt-4 mb-2">Sync databases</h2>
<ul class="ml-8 list-disc list-outside">
<li>index.sqlite3</li>
</ul>
<% changes = true %>
<% end %>

<% unless @pending['add'].blank? %>
<h2 class="font-bold text-2xl mt-4 mb-2">Add regions</h2>
<ul class="ml-8 list-disc list-outside">
<% @pending['add'].sort.each do |region| %>
<li><%= region %></li>
<% end %>
</ul>
<% changes = true %>
<% end %>

<% unless @move.blank? %>
<h2 class="font-bold text-2xl mt-4 mb-2">Move Sites</h2>
<table>
<thead>
<tr>
  <th class="row-head">Site</th>
  <th class="row-head">From</th>
  <th class="row-head">To</th>
</tr>
</thead>
<tbody>
<% @move.each do |site, change| %>
<tr>
  <td class="row"><%= site %></td>
  <td class="row"><%= change[:from] %></td>
  <td class="row"><%= change[:to] %></td>
</tr>
<% end %>
</tbody>
</table>
<% changes = true %>
<% end %>

<% unless @showcases_modified.blank? %>
<h2 class="font-bold text-2xl mt-4 mb-2">Events added/changed</h2>
<table>
<thead>
<tr>
  <th class="row-head">Year</th>
  <th class="row-head">Site</th>
  <th class="row-head">Event</th>
</tr>
</thead>
<tbody>
<% @showcases_modified.each do |showcase| %>
<tr>
  <td class="row"><%= showcase[0] %></td>
  <td class="row"><%= showcase[1] %></td>
  <td class="row"><%= showcase[2] %></td>
</tr>
<% end %>
</tbody>
</table>
<% changes = true %>
<% end %>

<% unless @showcases_removed.blank? %>
<h2 class="font-bold text-2xl mt-4 mb-2">Events removed</h2>
<table>
<thead>
<tr>
  <th class="row-head">Year</th>
  <th class="row-head">Site</th>
  <th class="row-head">Event</th>
</tr>
</thead>
<tbody>
<% @showcases_removed.each do |showcase| %>
<tr>
  <td class="row"><%= showcase[0] %></td>
  <td class="row"><%= showcase[1] %></td>
  <td class="row"><%= showcase[2] %></td>
</tr>
<% end %>
</tbody>
</table>
<% changes = true %>
<% end %>

<% unless @pending['delete'].blank? %>
<h2 class="font-bold text-2xl mt-4 mb-2">Delete regions</h2>
<ul class="ml-8 list-disc list-outside">
<% @pending['delete'].sort.each do |region| %>
<li><%= region %></li>
<% end %>
</ul>
<% changes = true %>
<% end %>

<% unless `git status --short | grep -v "^?? "`.empty? %>
<h2 class="font-bold text-2xl mt-4 mb-2">Code changes</h2>
<pre><%= `git status --short | grep -v "^?? "` %></pre>
<% changes = true %>
<% end %>

</div>

<div class="mt-6">
  <% if changes %>
    <% if @pending['add'].present? || @pending['delete'].present? || @code_changes %>
      <h3 class="text-xl font-bold text-center text-red-600">⚠️ Full Deployment Recommended</h3>
      <p class="text-sm text-gray-600 mb-4 text-center">Region or code changes detected</p>
    <% else %>
      <h3 class="text-xl font-bold text-center">Choose Update Method</h3>
      <p class="text-sm text-gray-600 mb-4 text-center">Configuration changes only - fast update recommended</p>
    <% end %>
  <% else %>
    <h3 class="text-xl font-bold text-center">Configuration Update</h3>
    <p class="text-sm text-gray-600 mb-4 text-center">No changes detected - update available for sync/recovery</p>
  <% end %>

  <div class="flex flex-col md:flex-row gap-4 justify-center items-center my-4">
    <!-- Fast configuration update (always available) -->
    <div class="flex flex-col items-center">
      <button type="button"
              data-action="click->config-update#triggerUpdate"
              class="bg-green-500 hover:bg-green-700 text-white font-bold py-2 px-4 border-2 rounded-xl">
        Update Configuration
      </button>
      <p class="text-xs text-gray-500 mt-1">Fast (~30 seconds)</p>
    </div>

    <!-- Full deployment (only show if changes exist) -->
    <% if changes %>
      <div class="flex flex-col items-center">
        <button data-submit-target="submit" data-stream="<%= @stream %>"
          class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 border-2 rounded-xl disabled:opacity-50 disabled:cursor-not-allowed">
          Full Deployment
        </button>
        <p class="text-xs text-gray-500 mt-1">Complete (~2-3 minutes)</p>
      </div>
    <% end %>
  </div>

  <!-- Progress indicator for configuration update (hidden initially) -->
  <div data-config-update-target="progress" class="hidden my-8">
    <div class="mb-2">
      <div class="w-full bg-gray-200 rounded-full h-6 overflow-hidden">
        <div data-config-update-target="progressBar"
             class="bg-blue-500 h-full text-xs font-medium text-white text-center p-0.5 leading-5 transition-all duration-300"
             style="width: 0%">
          0%
        </div>
      </div>
    </div>
    <p data-config-update-target="message" class="text-sm text-gray-600">
      Starting configuration update...
    </p>
  </div>
</div>

<div class="hidden p-4 bg-black rounded-xl">
<div data-submit-target="output" data-stream="<%= @stream %>"
  class="w-full mx-auto overflow-y-auto h-auto font-mono text-sm max-h-[25rem] min-h-[25rem]">
</div>
</div>

  <div class="mt-4 min-w-full flex flex-col items-center">
    <div>
    <%= link_to 'Refresh', admin_apply_path, class: "btn-blue" %>
    <%= link_to "Back to Admin", admin_path, class: "btn-green" %>
    </div>
  </div>
</div>
