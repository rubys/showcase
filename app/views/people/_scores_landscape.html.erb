<style>
  @page {
    size: A4 landscape;
    margin: 0.5in;
  }

  @media print {
    html, body {
      margin: 0;
      padding: 0;
      width: 100%;
      height: 100%;
    }

    .landscape-container {
      display: block !important;
      min-height: 0 !important;
      width: 100% !important;
      height: auto !important;
    }

    .landscape-content {
      transform: none !important;
      width: 100% !important;
      max-width: none !important;
      padding: 0 !important;
    }

    .landscape-content table {
      width: 100% !important;
      font-size: 0.7em;
      page-break-inside: auto;
    }

    .landscape-content tr {
      page-break-inside: avoid;
    }
  }

  @media screen {
    .landscape-container {
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: auto;
    }

    .landscape-content {
      transform: rotate(-90deg);
      transform-origin: center;
      width: 100vh;
      max-width: 100vh;
      padding: 20px;
    }

    .landscape-content table {
      font-size: 0.75em;
    }
  }
</style>

<div class="landscape-container">
<div class="landscape-content">
<% judge_ids = @judges.map(&:id) %>

<table style="break-before: page; width: 95%">
  <thead>
    <tr>
      <td colspan="<%= 5 + [@judges.length, 1].max + (@track_ages ? 1 : 0) %>" class="font-bold pt-8 text-3xl pb-5" >
        <%= person.name %>
        <span class="font-normal text-base float-right">
          <%= @event.name %>
        </span>
      </td>
    </tr>
    <tr>
      <td class="row-head">Heat</td>
      <% if @score_values != false %>
      <td class="row-head" colspan="<%= [@judges.length, 1].max %>">Scores</td>
      <% end %>
      <td class="row-head">Dance</td>
      <td class="row-head">Partner</td>
      <td class="row-head" colspan="<%= @track_ages ? 3 : 2 %>">Cat/Lvl</td>
      <% if %w(+ & @).include? @event.open_scoring %>
      <td class="row-head" colspan="<%= [@judges.length, 1].max %>">Great Job With</td>
      <td class="row-head" colspan="<%= [@judges.length, 1].max %>">Needs Work On</td>
      <% end %>
      <td class="row-head">Comments</td>
    </tr>
  </thead>
  <tbody>
    <% @heats.each do |heat| %>
    <% next unless [heat.entry.lead, heat.entry.follow].include?(person) or @formations.any? {|id, number| id == person.id && number == heat.number} %>
    <tr class="text-sm">
      <td class="text-center"><%= heat.number %></td>

      <!-- Scores -->
      <% if @judges.empty? %>
      <td></td>
      <% elsif heat.category == 'Open' and @event.open_scoring == '+' %>
      <% if @score_values != false %>
      <td colspan="<%= [@judges.length, 1].max %>"></td>
      <% end %>
      <% elsif @score_values != false %>
      <% judge_ids.each do |judge| %>
        <td class="text-center"><%= heat.scores.select {|score| score.judge_id == judge}.sort_by {it.slot || 0}.map { |score|
          display_val = score.display_value
          if display_val == 'F'
            Event.current.finalist
          else
            display_val
          end
        }.join(' ') %></td>
      <% end %>
      <% end %>

      <!-- Dance -->
      <td><div class="mx-4"><%= heat.category %> <%= heat.dance.name %></div></td>

      <!-- Partner -->
      <% if @formations.any? {|id, number| number == heat.number} %>
      <td><ul>
      <% ids = (@formations.select {|id, number| number == heat.number}.map(&:first) + [heat.entry.lead_id, heat.entry.follow_id]) - [person.id]
      Person.where(id: ids).by_name.each do |dancer| %>
      <li><div class="mx-4"><%= link_to dancer.display_name, dancer %></div></li>
      <% end %>
      </ul></td>
      <% else %>
      <% if heat.entry.lead != person %>
      <td><div class="mx-4"><%= link_to heat.entry.lead.display_name, heat.entry.lead %></div></td>
      <% end %>
      <% if heat.entry.follow != person %>
      <td><div class="mx-4"><%= link_to heat.entry.follow.display_name, heat.entry.follow %></div></td>
      <% end %>
      <% end %>

      <!-- Cat/Lvl -->
      <% lvlcat = heat.entry.subject_lvlcat.split(/\s*-\s*/) %>
      <td class="pl-4 text-right"><%= lvlcat[0] %></td>
      <td class="pl-1">- <%= lvlcat[1] %></td>
      <% if @track_ages %>
      <td class="text-left">- <%= lvlcat[2]&.strip %></td>
      <% end %>

      <!-- Feedback columns (Great Job With / Needs Work On) -->
      <% if %w(+ & @).include? @event.open_scoring %>
        <% if heat.category == 'Open' || (heat.category == 'Closed' && (@event.heat_range_cat > 0 || @event.closed_scoring == '=')) %>
          <% if @judges.empty? %>
          <td colspan="2"></td>
          <% else %>
          <% judge_ids.each do |judge| %>
            <td class="text-left ml-4"><span class="ml-2"><%= heat.scores.select {|score| score.judge_id == judge}.sort_by(&:slot).map(&:good).join(' | ') %></span></td>
          <% end %>
          <% judge_ids.each do |judge| %>
            <td class="text-left bg-gray-200"><span class="ml-2"><%= heat.scores.select {|score| score.judge_id == judge}.sort_by(&:slot).map(&:bad).join(' | ') %></span></td>
          <% end %>
          <% end %>
        <% else %>
          <td colspan="<%= [@judges.length * 2, 2].max %>"></td>
        <% end %>
      <% end %>

      <!-- Comments -->
      <td class="px-2 text-sm">
        <%= heat.scores.map { |score| score.comments if score.comments && !score.comments.blank? }.compact.join('; ') %>
      </td>
    </tr>
    <% end %>
  </tbody>

  <% if %w(+ & @).include? @event.open_scoring %>
  <tfoot>
  <tr>
  <td colspan="100">
  <h2 class="mt-4 ml-4 font-bold">Legend:</h2>
  <table class="ml-8 w-full">
  <% if Feedback.any? %>
    <% Feedback.ordered.each_slice(5) do |feedbacks| %>
    <tr>
      <% feedbacks.each do |feedback| %>
        <td><abbr><%= feedback.abbr %></abbr>: <span><%= feedback.value %></span></td>
      <% end %>
    </tr>
    <% end %>
  <% elsif @event.open_scoring == '+' %>
    <tr>
      <td><abbr>DF</abbr>: <span>Dance Frame</span></td>
      <td><abbr>T</abbr>: <span>Timing</span></td>
      <td><abbr>LF</abbr>: <span>Lead/&ZeroWidthSpace;Follow</span></td>
      <td><abbr>CM</abbr>: <span>Cuban Motion</span></td>
      <td><abbr>RF</abbr>: <span>Rise & Fall</span></td>
    </tr>
    <tr>
      <td><abbr>FW</abbr>: <span>Footwork</span></td>
      <td><abbr>B</abbr>: <span>Balance</span></td>
      <td><abbr>AS</abbr>: <span>Arm Styling</span></td>
      <td><abbr>CB</abbr>: <span>Contra-Body</span></td>
      <td><abbr>FC</abbr>: <span>Floor Craft</span></td>
    </tr>
  <% else %>
    <tr>
      <td><abbr>F</abbr>: <span>Frame</span></td>
      <td><abbr>P</abbr>: <span>Posture</span></td>
      <td><abbr>FW</abbr>: <span>Footwork</span></td>
      <td><abbr>LF</abbr>: <span>Lead/&ZeroWidthSpace;Follow</span></td>
      <td><abbr>T</abbr>: <span>Timing</span></td>
      <td><abbr>S</abbr>: <span>Styling</span></td>
    </tr>
  <% end %>
    </table>
  </td>
  </tr>
  </tfoot>
  <% end %>
</table>

<%
# Show scrutineering final rankings if person was in any scrutineering dances
person_scrutineering_results = []

# Initialize cache if not already done (for individual controller calls)
@scrutineering_cache ||= {}

# Find scrutineering dances for this person
person_scrutineering_dances = @heats.select { |heat|
  heat.dance.semi_finals && [heat.entry.lead, heat.entry.follow].include?(person)
}.map(&:dance).uniq

person_scrutineering_dances.each do |dance|
  # Calculate scrutineering results if not cached
  @scrutineering_cache[dance.id] ||= dance.scrutineering

  summary, ranks = @scrutineering_cache[dance.id]
  person_entries = @heats.select { |heat| heat.dance == dance && [heat.entry.lead, heat.entry.follow].include?(person) }
  person_entries.each do |heat|
    entry_id = heat.entry_id
    if ranks[entry_id]
      person_scrutineering_results << {
        dance: dance,
        heat: heat,
        rank: ranks[entry_id],
        summary: summary[entry_id]
      }
    end
  end
end
%>

<% unless person_scrutineering_results.empty? %>
<div class="break-inside-avoid">
<h2 class="text-center py-4 font-bold text-xl">Final Rankings (Scrutineering)</h2>
<table class="table-auto mr-24 border-collapse">
<thead>
  <tr>
    <td class="row-head">Heat</td>
    <td class="row-head">Dance</td>
    <td class="row-head">Partner</td>
    <td class="row-head">Individual Dance Results</td>
    <td class="row-head">Final Rank</td>
  </tr>
</thead>
<tbody>
<% person_scrutineering_results.each do |result| %>
  <tr class="border-y border-3 border-gray-200 m-2">
    <td class="text-center py-1"><%= result[:heat].number %></td>
    <td class="px-2"><%= result[:dance].name %></td>
    <td>
      <% if result[:heat].entry.lead != person %>
        <div class="mx-4"><%= link_to result[:heat].entry.lead.display_name, result[:heat].entry.lead %></div>
      <% end %>
      <% if result[:heat].entry.follow != person %>
        <div class="mx-4"><%= link_to result[:heat].entry.follow.display_name, result[:heat].entry.follow %></div>
      <% end %>
    </td>
    <td class="px-2 text-sm">
      <% if result[:summary] %>
        <% result[:summary].each do |dance_name, rank| %>
          <span class="inline-block mr-2"><%= dance_name %>: <%= rank %></span>
        <% end %>
      <% end %>
    </td>
    <td class="text-center font-bold text-lg"><%= result[:rank] %></td>
  </tr>
<% end %>
</tbody>
</table>
</div>
<% end %>
</div>
</div>
