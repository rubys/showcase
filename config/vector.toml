# Vector Configuration for Showcase Logging
# Receives logs from Navigator via Unix socket and forwards to NATS

# Global configuration
data_dir = "/Users/rubys/git/showcase/log/vector"

[sources.navigator]
type = "socket"
mode = "unix"
path = "/tmp/navigator-vector.sock"

[transforms.parse_json]
type = "remap"
inputs = ["navigator"]
source = '''
  # Parse the JSON message from Navigator
  original = parse_json!(string!(.message))

  # Add source field if missing (for HTTP access logs)
  if !exists(original.source) {
    if exists(original.client_ip) {
      original.source = "access"
    } else {
      original.source = "unknown"
    }
  }

  # Wrap in logfiler-expected format
  .timestamp = original."@timestamp"
  .message = encode_json(original)
  .log = {"level": "info"}
  .fly = {
    "app": {
      "name": "showcase",
      "instance": "rubymini"
    },
    "region": "rdu"
  }
  .source = original.source
'''

[sinks.nats]
type = "nats"
inputs = ["parse_json"]
url = "nats://localhost:4222"
subject = "logs.showcase.rubymini.{{ source }}"
encoding.codec = "json"
