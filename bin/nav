#!/bin/bash

export RAILS_ENV=production

# Parse command line options
PORT=9999
USE_REFACTORED=false
USE_MAINTENANCE=false
NAVIGATOR_CMD="bin/navigator"
CONFIG_FILE=""

while [[ "$#" -gt 0 ]]; do
    case $1 in
        --refactored|-r) USE_REFACTORED=true ;;
        --maintenance|-m) USE_MAINTENANCE=true ;;
        --help|-h)
            echo "Usage: $0 [options]"
            echo "Options:"
            echo "  -r, --refactored    Use navigator-refactored instead of navigator"
            echo "  -m, --maintenance   Use config/navigator-maintenance.yml"
            echo "  -h, --help          Show this help message"
            exit 0
            ;;
        *) echo "Unknown option: $1"; exit 1 ;;
    esac
    shift
done

# Set navigator command
if [ "$USE_REFACTORED" = true ]; then
    NAVIGATOR_CMD="navigator/bin/navigator-refactored"
    # Build refactored version if it doesn't exist
    if [ ! -f "$NAVIGATOR_CMD" ]; then
        echo "Building navigator-refactored..."
        (cd navigator && go build -o bin/navigator-refactored cmd/navigator-refactored/main.go)
    fi
fi

# Set config file
if [ "$USE_MAINTENANCE" = true ]; then
    CONFIG_FILE="config/navigator-maintenance.yml"
    PORT=3000
else
    CONFIG_FILE="config/navigator.yml"
fi

if lsof -i :$PORT -t >/dev/null; then
    lsof -i :$PORT -t | xargs -r kill -INT
    sleep 1
fi

if [ ! -d "public/assets" ]; then
    bin/rails assets:precompile
fi

if [ ! -d "public/docs" ]; then
    bin/prerender
fi

if [ ! -f "$CONFIG_FILE" ] || [ "db/index.sqlite3" -nt "$CONFIG_FILE" ]; then
    if [ "$USE_MAINTENANCE" = false ]; then
        bin/rails nav:config
    fi
fi

open -a Firefox http://localhost:$PORT

if [ -n "$CONFIG_FILE" ]; then
    $NAVIGATOR_CMD $CONFIG_FILE
else
    $NAVIGATOR_CMD
fi
