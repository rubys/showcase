#!/bin/bash

SLEEP_MODE=false

# Parse arguments
for arg in "$@"; do
  case "$arg" in
    clobber)
      bin/bundle exec rake prerender:clobber
      exit 0
      ;;
    --sleep)
      SLEEP_MODE=true
      ;;
    nav)
      bin/bundle exec rake nav:config
      bin/bundle exec rake assets:precompile
      ;;
  esac
done

export RAILS_ENV=production
bin/bundle exec rake prerender > log/prerender.log

if [ -n "$AWS_ACCESS_KEY_ID" ]; then
  bin/rails assets:bridge
fi

input_file="tmp/tenants.list"
lines=()

if [ -f "$input_file" ] && [ -n "$FLY_REGION" ]; then
  while IFS= read -r line; do
    lines+=("$line")
  done < "$input_file"

  if [ ${#lines[@]} -gt 0 ]; then
    ruby bin/prepare.rb "${lines[@]}"
  fi
fi

# Sleep infinity when --sleep is passed (for Procfile.fly to keep process running)
if [ "$SLEEP_MODE" = true ]; then
  sleep infinity
fi
