<script>
  function audioSourceError(event) {
    const enclosing = event.target.parentNode.parentNode;
    enclosing.style.backgroundColor = "red";
    document.querySelector(".info-box").style.display = "block";
  }
</script>

<div class="w-full">
  <% if notice.present? %>
    <p class="py-2 px-3 bg-green-50 mb-5 text-green-500 font-medium rounded-lg inline-block" id="notice"><%= notice %></p>
  <% end %>

  <div data-controller="info-box">
    <div class="info-button">&#x24D8;</div>
   
    <ul class="info-box list-none">
    <li class="text-xl mb-4 text-center">Having Trouble?</li>
    <ul class="list-disc ml-4">
    <li>Refresh the page; there may have been wifi issues.</li>
    <li>Click "Cache Songs Locally" to download all songs and store them in this page. This allows playback without network connectivity. Songs stay cached even if wifi drops.</li>
    <li>Consider downloading an offline version of the playlist. This is a multi-step process:
      <ol class="list-decimal ml-4">
        <li>Click the "Prepare Offline Version" button.</li>
        <li>Wait for the preparation to complete.</li>
        <li>Download the generated ZIP file.</li>
        <li>Open the ZIP file and examine its contents.</li>
        <li>Open the HTML file in a web browser to play the audio files locally.</li>
      </ol>
    </li>
    <li>Try a different browser.  Safari, Chrome, Firefox, and Edge all support different audio formats.</li>
    <li>Try a different site:
    <ul class="mt-2 list-disc ml-4">
    <% prefix = ENV['RAILS_APP_SCOPE'] ? "" : "/" + ENV['RAILS_APP_DB'].sub('-', '/') %>
    <% unless ENV['FLY_REGION'] %>
    <li><a class="underline" href="https://smooth.fly.dev/showcase<%= prefix + djlist_solos_path.sub('/showcase', '') %>">fly.io</a> - Primary cloud host</li>
    <% end %>
    <% unless ENV['RAILS_PROXY_HOST'].to_s.split('.').first == 'hetzner' %>
    <li><a class="underline" href="https://showcase.party<%= prefix + djlist_solos_path.sub('/showcase', '') %>">hetzner</a> - Backup cloud host</li>
    <% end %>
    <% unless ENV['RAILS_PROXY_HOST'].to_s.split('.').first == 'rubix' %>
    <li><a class="underline" href="https://rubix.intertwingly.net/showcase<%= prefix + djlist_solos_path.sub('/showcase', '') %>">rubix</a> - Sam's attic</li>
    <% end %>
    <p class="mt-2">
    <span class="text-red-600 mt-2"><span class="font-bold">Important</span>: never <span class="underline font-bold">update</span> data on multiple hosts or you will lose data.</span>
    For example, all judges should be on the same host; but the emcee could be on a different host.
    </p>
    </ul>
    </ul>
    </ul>
  </div>

  <div class="flex justify-between items-center" data-controller="offline-playlist progressive-audio" data-offline-playlist-cleanup-url-value="<%= djlist_cleanup_cache_solos_path %>" data-offline-playlist-stream-value="offline_playlist_<%= ENV['RAILS_APP_DB'] %>_<%= @request_id %>" data-offline-playlist-request-id-value="<%= @request_id %>">
    <%= turbo_stream_from "offline_playlist_#{ENV['RAILS_APP_DB']}_#{@request_id}" %>
    <h1 class="mx-auto font-bold text-4xl">Solos</h1>
    <div class="ml-4">
      <button data-progressive-audio-target="button"
              data-action="click->progressive-audio#cache"
              class="px-4 py-2 bg-green-500 text-white rounded hover:bg-green-600 mr-2"
              title="Download and cache all songs locally in this page for playback without network">
        Cache Songs Locally
      </button>

      <button data-offline-playlist-target="button"
              data-action="click->offline-playlist#generate"
              class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600"
              title="Generate and download a self-contained HTML file with embedded audio for offline playback">
        Prepare Offline Version
      </button>

      <div data-progressive-audio-target="progress" class="hidden mt-4">
        <div class="mb-2">
          <div class="w-full bg-gray-200 rounded-full h-6 overflow-hidden">
            <div data-progressive-audio-target="progressBar"
                 class="bg-blue-500 h-full text-xs font-medium text-white text-center p-0.5 leading-5 transition-all duration-300"
                 style="width: 0%">
              0%
            </div>
          </div>
        </div>
        <p data-progressive-audio-target="message" class="text-sm text-gray-600">
          Caching songs...
        </p>
      </div>

      <div data-offline-playlist-target="progress" class="hidden mt-4">
        <div class="mb-2">
          <div class="w-full bg-gray-200 rounded-full h-6 overflow-hidden">
            <div data-offline-playlist-target="progressBar"
                 class="bg-blue-500 h-full text-xs font-medium text-white text-center p-0.5 leading-5 transition-all duration-300"
                 style="width: 0%">
              0%
            </div>
          </div>
        </div>
        <p data-offline-playlist-target="message" class="text-sm text-gray-600">
          Preparing download...
        </p>
      </div>
    </div>
  </div>

  <div class="min-w-full">
  <table class="mt-4 table-auto mx-auto">
  <thead>
    <th class="row-head">Heat</th>
    <th class="row-head">Dance</th>
    <th class="row-head">Song</th>
    <th class="row-head">Lead</th>
    <th class="row-head">Follow</th>
    <th class="row-head">Studio</th>
  </thead>
  <% @heats.each do |heat| %>
    <% next if heat.number <= 0 %>
    <tr class="hover:bg-yellow-200" id="<%= dom_id heat.solo %>">
       <td class="text-center"><div style="line-height: 5rem"><%= heat.number %></div></td>
       <td class="row">
       <ul class="list-none">
       <li><% if heat.category == 'Solo' and heat.solo.combo_dance %>
       <%= link_to heat.dance.name, edit_dance_path(heat.dance) %> / 
       <%= link_to heat.solo.combo_dance.name, edit_dance_path(heat.solo.combo_dance) %>
       <% else %>
       <%= link_to heat.dance.name, edit_dance_path(heat.dance) %>
       <% end %></li>
       <% unless heat.solo.song.blank? %><li><%= heat.solo.song %></li><% end %>
       <% unless heat.solo.artist.blank? %><li><%= heat.solo.artist %></li><% end %>
       </ul>
       </td>
       <% if heat.solo.song_file.attached? %>
       <td>
         <audio controls preload="none" style="display: inline">
           <source src=<%= heat.solo.song_file.url %> type=<%= heat.solo.song_file.content_type %> onerror="audioSourceError(event)">
         </audio>
       </td>
       <% else %>
       <td>
         <div class="bg-red-50 text-red-700 px-3 py-2 rounded text-center">
           No audio file
         </div>
       </td>
       <% end %>
       <td class="row"><%= link_to heat.lead.display_name, polymorphic_path(heat.lead, anchor: 'heats') %>
       <% heat.solo.formations.each_with_index do |formation, index| %>
         <% if index % 2 == 0 and formation.on_floor %>
         <br><%= link_to formation.person.display_name, polymorphic_path(formation.person, anchor: 'heats') %>
         <% end %>
       <% end %>
       </td>
       <td class="row"><%= link_to heat.follow.display_name, polymorphic_path(heat.follow, anchor: 'heats') %>
       <% heat.solo.formations.each_with_index do |formation, index| %>
         <% if index % 2 == 1 and formation.on_floor %>
         <br><%= link_to formation.person.display_name, polymorphic_path(formation.person, anchor: 'heats') %>
         <% end %>
       <% end %>
       </td>
       <td class="row"><%= link_to heat.studio.name, heat.studio %></td>
    </tr>
  <% end %>
  </table>
</div>

</div>