# Navigator - Go Web Server

Navigator is a Go-based replacement for nginx + Phusion Passenger that provides multi-tenant Rails application hosting with on-demand process management.

## Overview

Navigator supports both nginx-style and modern YAML configuration formats:
- **Multi-tenant hosting**: Manages multiple Rails applications with separate databases
- **On-demand process management**: Starts Rails apps when needed, stops after idle timeout
- **Static file serving**: Serves assets, images, and static content directly from filesystem with configurable caching
- **Authentication**: Full htpasswd support (APR1, bcrypt, SHA, etc.) with pattern-based exclusions
- **URL rewriting**: Nginx-style rewrite rules with redirect and last flags
- **Reverse proxy**: Forwards dynamic requests to Rails applications
- **Dual configuration**: Supports both nginx config files (deprecated) and modern YAML format

## Building and Running

```bash
# Build the navigator
make build

# Run with YAML configuration (recommended - default location)
./bin/navigator
# Or specify a custom config file
./bin/navigator config/navigator.yml

# Run with nginx configuration (deprecated)
./bin/navigator tmp/showcase.conf

# The navigator will:
# - Auto-detect configuration format (YAML vs nginx)
# - Start listening on the configured port (default: 3000)
# - Manage Rails applications on-demand starting from port 4000+
```

## Configuration Formats

Navigator supports two configuration formats:

### YAML Configuration (Recommended)

Clean, structured configuration generated by Rails:

```yaml
server:
  listen: 3000
  hostname: localhost
  root_path: /showcase
  public_dir: /path/to/public

pools:
  max_size: 22
  idle_timeout: 300
  start_port: 4000

auth:
  enabled: true
  realm: Showcase
  htpasswd: /path/to/htpasswd
  public_paths:
    - /showcase/assets/
    - /showcase/docs/
    - "*.css"
    - "*.js"

static:
  directories:
    - path: /showcase/assets/
      root: assets/
      cache: 86400
  extensions: [html, htm, css, js, png, jpg, gif]
  try_files:
    enabled: true
    suffixes: [".html", ".htm", ".txt"]

applications:
  global_env:
    RAILS_RELATIVE_URL_ROOT: /showcase
  
  # Standard environment variables applied to all tenants (except special ones)
  standard_vars:
    RAILS_APP_DB: "${tenant.database}"
    DATABASE_URL: "sqlite3:///path/to/db/${tenant.database}.sqlite3"
    RAILS_APP_OWNER: "${tenant.owner}"
    RAILS_STORAGE: "${tenant.storage}"
    RAILS_APP_SCOPE: "${tenant.scope}"
    PIDFILE: "/path/to/pids/${tenant.database}.pid"
  
  tenants:
    - name: 2025-boston
      path: /showcase/2025/boston/
      group: showcase-2025-boston
      database: 2025-boston
      owner: "Boston Dance Studio"
      storage: "/path/to/storage/2025-boston"
      scope: "2025/boston"
      env:
        SHOWCASE_LOGO: "boston-logo.png"
    
    # Special tenants that don't use standard_vars
    - name: cable
      path: /cable
      group: showcase-cable
      special: true
      force_max_concurrent_requests: 0
```

### Nginx Configuration (Deprecated)

Navigator also parses nginx configuration files and extracts:

### Server Directives
- `listen 9999` - Port to listen on
- `server_name localhost` - Server name
- `passenger_max_pool_size 54` - Maximum number of Rails processes

### Location Blocks
```nginx
location /showcase/2025/boston/ {
  root /Users/rubys/git/showcase/public;
  passenger_app_group_name showcase-boston-2025;
  passenger_env_var RAILS_APP_DB "2025-boston";
  passenger_env_var RAILS_STORAGE "/path/to/storage";
}
```

### Rewrite Rules
```nginx
rewrite ^/(showcase)?$ /showcase/ redirect;
rewrite ^/assets/ /showcase/assets/ last;
```

### Authentication Patterns
```nginx
if ($request_uri ~ "^/showcase/assets/") { set $realm off; }
auth_basic_user_file /path/to/htpasswd;
```

## Architecture

### Process Management
- **On-demand startup**: Rails apps start when first requested
- **Idle timeout**: Apps automatically shut down after 10 minutes of inactivity
- **Port allocation**: Sequential port assignment starting from 4000
- **Environment variables**: Passed from configuration to Rails processes

### Static File Serving
Serves files directly from filesystem for performance:
- **Assets**: `/assets/` → `public/assets/`
- **Images**: `*.png`, `*.jpg`, `*.gif` → `public/`
- **Documentation**: `/docs/` → `public/docs/`
- **Regions**: `/regions/` → `public/regions/`
- **Studios**: `/studios/` → `public/studios/`
- **Fonts**: `/fonts/` → `public/fonts/`

### Try Files Behavior
For non-authenticated routes, implements nginx-style `try_files` behavior:
- **Auto-extension detection**: `/showcase/studios/raleigh` → `raleigh.html`
- **Extension priority**: `.html`, `.htm`, `.txt`, `.xml`, `.json`
- **Fallback to Rails**: If no static file found, proxies to Rails application
- **Content-Type detection**: Automatic MIME type setting based on file extension

### Authentication
- **Multiple formats**: Full htpasswd support via go-htpasswd library (APR1, bcrypt, SHA, MD5-crypt, etc.)
- **Pattern-based exclusions**: Simple glob patterns and regex patterns for public paths
- **Basic Auth**: Standard HTTP Basic Authentication

### Request Flow
1. **Rewrite rules**: Applied first for redirects and path modifications
2. **Authentication**: Checked against patterns and htpasswd file
3. **Static files**: Attempted if path matches static patterns (assets, explicit extensions)
4. **Try files**: For non-authenticated routes, attempts to find static files with common extensions
5. **Rails proxy**: Falls back to starting/proxying to Rails application

## Key Features

### Configuration-Driven
- **No recompilation needed**: All patterns parsed from config file
- **Dynamic reloads**: Restart navigator to pick up config changes
- **Nginx compatibility**: Reads standard nginx configuration syntax

### Performance Optimizations
- **Static file serving**: Bypasses Rails for assets and static content
- **Try files optimization**: Serves public content (studios, regions, docs) without Rails
- **Process pooling**: Reuses Rails processes across requests
- **Concurrent handling**: Multiple requests processed simultaneously
- **Proper content types**: Automatic MIME type detection
- **Zero Rails overhead**: Public routes serve static files instantly

### Rails Compatibility
- **Full path preservation**: Rails receives complete URL paths for routing
- **Environment variables**: All passenger_env_var directives passed through
- **Process lifecycle**: Proper startup, shutdown, and error handling
- **Request headers**: X-Forwarded-* headers set correctly

## Development

### File Structure
- `cmd/navigator/main.go` - Main application entry point
- `Makefile` - Build configuration
- `go.mod`, `go.sum` - Go module dependencies

### Key Functions
- `ParseConfig()` - Parses nginx configuration files
- `serveStaticFile()` - Handles static file serving for assets and explicit extensions
- `tryFiles()` - Implements nginx-style try_files for non-authenticated routes
- `handleRewrites()` - Processes URL rewrite rules
- `shouldExcludeFromAuth()` - Checks authentication exclusion patterns
- `NewAppManager()` - Manages Rails application lifecycle

### Testing
```bash
# Test static asset serving
curl -I http://localhost:9999/showcase/assets/application.js

# Test try_files behavior (non-authenticated routes)
curl -I http://localhost:9999/showcase/studios/raleigh        # → raleigh.html
curl -I http://localhost:9999/showcase/regions/dfw           # → dfw.html

# Test authentication
curl -u username:password http://localhost:9999/protected/path

# Test Rails proxy (authenticated routes)
curl -u test:secret http://localhost:9999/showcase/2025/boston/
```

## Deployment

Navigator is designed to replace nginx + Passenger in production environments:
- **Single binary**: No external dependencies
- **Configuration compatibility**: Uses existing nginx config files
- **Resource efficiency**: Lower memory footprint than full nginx/Passenger stack
- **Monitoring**: Built-in logging for requests, static files, and process management

## Limitations

- **Single-threaded config parsing**: Configuration loaded once at startup
- **No SSL termination**: Designed to run behind load balancer/CDN
- **SQLite focus**: Optimized for SQLite-based multi-tenant applications
- **Basic proxy features**: Supports essential reverse proxy functionality
- **Try files scope**: Only applies to non-authenticated routes for security

## Nginx Equivalent

Navigator's try_files implementation is equivalent to nginx configuration like:

```nginx
location /showcase/studios/ {
    auth_basic off;
    try_files $uri $uri.html $uri.htm $uri.txt $uri.xml $uri.json @rails;
}

location /showcase/regions/ {
    auth_basic off;
    try_files $uri $uri.html $uri.htm $uri.txt $uri.xml $uri.json @rails;
}

location @rails {
    proxy_pass http://rails_app;
}
```

This provides zero Rails overhead for public content while maintaining security for protected routes.

## Future Implementation Ideas

The following features are planned for future development to enhance Navigator's capabilities:

### 1. Complete Go Library Refactoring
- **Router improvements**: Replace basic `http.ServeMux` with `chi` router (already in go.mod) for better routing patterns and middleware support
- **Configuration management**: Add `viper` or `koanf` for more flexible configuration handling and validation
- **Static serving middleware**: Use `chi/middleware` for enhanced static file handling with better caching controls

### 2. Missing YAML Feature Implementation
Several YAML configuration fields are parsed but not yet fully utilized:
- **Health check configuration**: Make health endpoint configurable beyond hardcoded `/up`
- **Logging configuration**: Implement log level and format settings from YAML
- **Process management**: Enforce min_instances setting for critical applications
- **Cache headers**: Full implementation of TTL configuration for static file caching

### 3. Developer Experience Improvements
- **Configuration validation**: Validate YAML configuration on startup with helpful error messages
- **Hot reload**: Watch YAML configuration file and reload without restart
- **Debug modes**: Add verbose logging modes and metrics endpoint for troubleshooting
- **Configuration testing**: Tool to test configuration without starting full server

### 4. Migration and Deprecation Path
- **Deprecation timeline**: Set clear timeline for removing nginx configuration support
- **Migration tooling**: Automated script to convert existing nginx configs to YAML format
- **Documentation updates**: Comprehensive migration guide and updated deployment documentation

### 5. Production Readiness Enhancements
- **Graceful shutdown**: Proper SIGTERM handling for zero-downtime deployments
- **Connection pooling**: Improved HTTP client management for Rails application proxying
- **Error handling**: More robust error responses, recovery mechanisms, and structured logging
- **Monitoring**: Built-in metrics collection and health monitoring capabilities

### 6. Rails Integration Improvements
- **Automatic generation**: Have Rails automatically call `generate_navigator_config` during deployment
- **Deployment automation**: Update deployment scripts to use YAML format by default
- **Performance monitoring**: Add request/response metrics and Rails application performance tracking
- **Dynamic configuration**: Allow Rails to update Navigator configuration without restart

### 7. Advanced Features
- **Load balancing**: Support for multiple Rails backend instances per tenant
- **SSL termination**: Optional SSL/TLS support for development environments
- **Rate limiting**: Request rate limiting per tenant or globally
- **Request routing**: Advanced routing based on headers, query parameters, or custom logic

These improvements would make Navigator a more complete, production-ready web server while maintaining its focus on simplicity and performance for Rails multi-tenant applications.