# Name of your application. Used to uniquely configure containers.
service: showcase-logger

# Name of the container image.
image: samruby/showcase-logger

# Deploy to these servers.
servers:
  web:
    hosts:
      - 65.109.81.136
    options:
      add-host: host.docker.internal:host-gateway

# Enable SSL auto certification via Let's Encrypt and allow for multiple apps on a single web server.
# Remove this section when using multiple web servers and ensure you terminate SSL at your load balancer.
#
# Note: If using Cloudflare, set encryption mode in SSL/TLS setting to "Full" to enable CF-to-app encryption. 
proxy: 
  ssl: true
  host: logger.showcase.party

# Credentials for your image host.
registry:
  username: samruby

  # Always use an access token rather than real password (pulled from .kamal/secrets).
  password:
    - KAMAL_REGISTRY_PASSWORD

# Configure builder setup.
builder:
  context: .
  arch: amd64
  remote: ssh://root@65.109.81.136
  local: false

# Inject ENV variables into containers (secrets come from .kamal/secrets).
env:
  clear:
    KAMAL_HETZNER: 1
  secret:
    - HTPASSWD

# Configure logging
logging:
  driver: local
  options:
    max-size: 20m
    max-file: 5

# Aliases are triggered with "bin/kamal <alias>". You can overwrite arguments on invocation:
# "bin/kamal logs -r job" will tail logs from the first server in the job section.
aliases:
  console: app exec --interactive --reuse "bash"

# Use a persistent storage volume.
volumes:
  - /home/rubys/logs:/logs

# Accessories for logging infrastructure
accessories:
  vector:
    service: logger-vector
    image: vectordotdev/vector:latest
    host: 65.109.81.136
    volumes:
      - vector-data:/var/lib/vector
      - /home/rubys/logs:/logs
    env:
      secret:
        - RAILS_MASTER_KEY
    files:
      - accessories/files/vector.toml:/etc/vector/vector.toml

  traefik:
    service: logger-traefik
    image: traefik:v3.0
    host: 65.109.81.136
    env:
      clear:
        TRAEFIK_DOMAIN: hub.showcase.party
    port: 9000
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - traefik-data:/data
    cmd: >
      --api.dashboard=false
      --entrypoints.vector.address=:9000
      --providers.file.filename=/data/traefik.yml
      --certificatesresolvers.letsencrypt.acme.tlschallenge=true
      --certificatesresolvers.letsencrypt.acme.email=rubys@intertwingly.net
      --certificatesresolvers.letsencrypt.acme.storage=/data/acme.json
      --log.level=INFO
    files:
      - accessories/files/traefik.yml:/data/traefik.yml
