<div class="w-full">
  <% if notice.present? %>
    <p class="py-2 px-3 bg-green-50 mb-5 text-green-500 font-medium rounded-lg inline-block" id="notice"><%= notice %></p>
  <% end %>

  <div data-controller="info-box">
    <div class="info-button">&#x24D8;</div>
    <ul class="info-box">
      <% if @is_multi %>
      <li>Split competitions into divisions by level, then age, then couple type. Splits are layered - first split by level, then within each level by age, then within each level+age by couple type.
      <% else %>
      <li>This page shows all entries (scheduled heats) filtered by your selections. Use dropdown filters to narrow the view.
      <ul>
      <li><strong>Level</strong>: Filter by dance level (Newcomer, Bronze, Silver, Gold, etc.). Leave blank to see all levels.
      <li><strong>Age</strong>: Filter by age category if age tracking is enabled for your event.
      <li><strong>Couple Type</strong>: Filter by Pro-Am (instructor/student), Amateur Couple (student/student), or Professional (instructor/instructor).
      </ul>
      <% end %>
      <li>Green and yellow rows indicate different splits. <span class="text-white bg-red-600 px-1">Red highlighting</span> indicates dancers appearing multiple times within the same split.
      <li>Click column headings (lead, follow, dance, level, age) to sort entries by that column.
      <li>Hover over any entry and click "Edit" to modify that specific heat. Crossed-out entries have been scratched.
    </ul>
  </div>

  <div>
    <h1 class="font-bold text-4xl text-center mb-4"><%= @dance_name || "Entries" %></h1>
  </div>

  <% unless @is_multi %>
  <div class="flex align-center justify-center mb-4">
  <form class="flex columns-3 gap-4" data-controller="auto-submit">
    <div>
      <%= select_tag "level", options_for_select(@levels, @level), prompt: "Level",
        class: "block shadow rounded-md border border-gray-200 outline-none px-3 py-2 mt-2 w-40" %>
    </div>
    <% if @track_ages %>
    <div>
      <%= select_tag "age", options_for_select(@ages, @age), prompt: "Age",
        class: "block shadow rounded-md border border-gray-200 outline-none px-3 py-2 mt-2 w-40" %>
    </div>
    <div>
      <%= select_tag "couple", options_for_select(@couple_types, @couple), prompt: "Couple Type",
        class: "block shadow rounded-md border border-gray-200 outline-none px-3 py-2 mt-2 w-40" %>
    </div>
    <% end %>
    <input type="hidden" name="dance" value="<%= @dance %>">
    <button type="submit" class="hidden">Filter</button>
  </form>
  </div>
  <% end %>

  <% if @is_multi %>
  <div class="mb-6">
    <div class="flex justify-center items-center gap-4 mb-3">
      <h2 class="font-bold text-2xl text-center">Competition Splits</h2>
      <% if @multi_levels.any? %>
        <%= button_to "Reset Splits", reset_splits_entries_path(dance: @dance),
            method: :post,
            class: "btn-sm bg-orange-500 hover:bg-orange-600 text-white px-3 py-1 rounded text-sm",
            data: { turbo_confirm: "This will remove all splits and combine everything into one competition. Continue?" } %>
      <% end %>
    </div>

    <%# Desktop table view - hidden on small screens %>
    <div class="hidden md:block">
      <table class="mx-auto border border-gray-300">
        <thead class="bg-gray-100">
          <tr>
            <th class="px-4 py-2 border">Name</th>
            <th class="px-4 py-2 border">Start Level</th>
            <th class="px-4 py-2 border">Stop Level</th>
            <% if @track_ages && @age_ids&.length.to_i > 1 %>
            <th class="px-4 py-2 border">Start Age</th>
            <th class="px-4 py-2 border">Stop Age</th>
            <% end %>
            <% if @couple_types_present&.length.to_i > 1 %>
            <th class="px-4 py-2 border">Couple Type</th>
            <% end %>
            <th class="px-4 py-2 border text-center">Couples</th>
          </tr>
        </thead>
        <tbody>
          <% if @multi_levels.empty? %>
            <tr>
              <td class="px-4 py-2 border">All</td>
              <td class="px-4 py-2 border"><%= Level.find(@min_level).name %></td>
              <td class="px-4 py-2 border">
                <% if @level_ids.length > 1 %>
                <%= form_with url: split_multi_entries_path, method: :post, data: { controller: "auto-submit" } do |f| %>
                  <%= f.hidden_field :dance_id, value: @dance %>
                  <%= f.hidden_field :dance, value: @dance %>
                  <%= f.hidden_field :couple, value: @couple %>
                  <%= f.hidden_field :level, value: @level %>
                  <%= f.hidden_field :age, value: @age %>
                  <%= f.hidden_field :sort, value: params[:sort] %>
                  <%= f.select :stop_level,
                      @levels.select { |name, id| @level_ids.include?(id) && id >= @min_level }.map { |name, id| [name, id] },
                      { selected: @max_level },
                      class: "shadow rounded-md border border-gray-200 outline-none px-2 py-1" %>
                <% end %>
                <% else %>
                <%= Level.find(@max_level).name %>
                <% end %>
              </td>
              <% if @track_ages && @age_ids&.length.to_i > 1 %>
              <td class="px-4 py-2 border"><%= Age.find(@min_age).description %></td>
              <td class="px-4 py-2 border">
                <%= form_with url: split_multi_entries_path, method: :post, data: { controller: "auto-submit" } do |f| %>
                  <%= f.hidden_field :dance_id, value: @dance %>
                  <%= f.hidden_field :dance, value: @dance %>
                  <%= f.hidden_field :couple, value: @couple %>
                  <%= f.hidden_field :level, value: @level %>
                  <%= f.hidden_field :age, value: @age %>
                  <%= f.hidden_field :sort, value: params[:sort] %>
                  <%= f.select :stop_age,
                      @ages.select { |desc, id| @age_ids.include?(id) && id >= @min_age }.map { |desc, id| [desc, id] },
                      { selected: @max_age },
                      class: "shadow rounded-md border border-gray-200 outline-none px-2 py-1" %>
                <% end %>
              </td>
              <% end %>
              <% if @couple_types_present&.length.to_i > 1 %>
              <td class="px-4 py-2 border">
                <%= form_with url: split_multi_entries_path, method: :post, data: { controller: "auto-submit" } do |f| %>
                  <%= f.hidden_field :dance_id, value: @dance %>
                  <%= f.hidden_field :dance, value: @dance %>
                  <%= f.hidden_field :couple, value: @couple %>
                  <%= f.hidden_field :level, value: @level %>
                  <%= f.hidden_field :age, value: @age %>
                  <%= f.hidden_field :sort, value: params[:sort] %>
                  <%= f.select :couple_split,
                      [['All', ''], ['Pro-Am vs Amateur', 'pro_am_vs_amateur'], ['Am Lead / Am Follow / Am Couple', 'amateur_lead_follow']],
                      { selected: '' },
                      class: "shadow rounded-md border border-gray-200 outline-none px-2 py-1" %>
                <% end %>
              </td>
              <% end %>
              <td class="px-4 py-2 border text-center"><%= @heats.select { |h| h.number > 0 }.map(&:entry_id).uniq.count %></td>
            </tr>
          <% else %>
            <%
              # Group multi_levels by level range for display
              grouped_by_level = @multi_levels.group_by { |ml| [ml.start_level, ml.stop_level] }
            %>
            <% @multi_levels.each_with_index do |ml, index| %>
              <%
                # Determine if this is the last row in its level group (for age splitting)
                level_group = grouped_by_level[[ml.start_level, ml.stop_level]]
                is_last_in_level_group = level_group.last == ml

                # Determine if this multi_level has age splits or is ready for age splitting
                has_age_range = ml.start_age.present? && ml.stop_age.present?
                can_age_split = @track_ages && @age_ids&.length.to_i > 1 && is_last_in_level_group

                # Count heats matching this multi_level
                matching_heats = @heats.select do |h|
                  e = h.entry
                  next false unless e.level_id >= ml.start_level && e.level_id <= ml.stop_level
                  if ml.start_age.present? && ml.stop_age.present?
                    next false unless e.age_id >= ml.start_age && e.age_id <= ml.stop_age
                  end
                  # Couple type matching
                  if ml.couple_type.present?
                    lead_type = e.lead.type
                    follow_type = e.follow.type
                    entry_couple_type = if lead_type == 'Student' && follow_type == 'Professional'
                      'Amateur Lead'
                    elsif lead_type == 'Professional' && follow_type == 'Student'
                      'Amateur Follow'
                    elsif lead_type == 'Student' && follow_type == 'Student'
                      'Amateur Couple'
                    else
                      'Professional'
                    end

                    case ml.couple_type
                    when 'Pro-Am'
                      next false unless ['Amateur Lead', 'Amateur Follow'].include?(entry_couple_type)
                    when 'Amateur Couple'
                      next false unless entry_couple_type == 'Amateur Couple'
                    when 'Amateur Lead'
                      next false unless entry_couple_type == 'Amateur Lead'
                    when 'Amateur Follow'
                      next false unless entry_couple_type == 'Amateur Follow'
                    end
                  end
                  true
                end
              %>
              <tr class="<%= index.even? ? 'bg-green-50' : 'bg-yellow-50' %>">
                <td class="px-4 py-2 border">
                  <%= form_with url: split_multi_entries_path, method: :post, data: { controller: "auto-submit" } do |f| %>
                    <%= f.hidden_field :multi_level_id, value: ml.id %>
                    <%= f.hidden_field :dance, value: @dance %>
                    <%= f.hidden_field :couple, value: @couple %>
                    <%= f.hidden_field :level, value: @level %>
                    <%= f.hidden_field :age, value: @age %>
                    <%= f.hidden_field :sort, value: params[:sort] %>
                    <%= f.text_field :name, value: ml.name,
                        class: "shadow rounded-md border border-gray-200 outline-none px-2 py-1 w-full" %>
                  <% end %>
                </td>
                <td class="px-4 py-2 border"><%= Level.find(ml.start_level).name %></td>
                <td class="px-4 py-2 border">
                  <%
                    # Only show level split dropdown if no age/couple splits yet for this level range
                    level_siblings = @multi_levels.select { |m| m.start_level == ml.start_level && m.stop_level == ml.stop_level }
                    can_level_split = level_siblings.length == 1 && (index < @multi_levels.length - 1 || ml.start_level != ml.stop_level)
                  %>
                  <% if can_level_split %>
                    <%= form_with url: split_multi_entries_path, method: :post, data: { controller: "auto-submit" } do |f| %>
                      <%= f.hidden_field :multi_level_id, value: ml.id %>
                      <%= f.hidden_field :dance, value: @dance %>
                      <%= f.hidden_field :couple, value: @couple %>
                      <%= f.hidden_field :level, value: @level %>
                      <%= f.hidden_field :age, value: @age %>
                      <%= f.hidden_field :sort, value: params[:sort] %>
                      <%
                        if index < @multi_levels.length - 1
                          available_levels = @levels.select { |name, id| @level_ids.include?(id) && id >= ml.start_level && id <= @max_level }
                        else
                          available_levels = @levels.select { |name, id| @level_ids.include?(id) && id >= ml.start_level && id <= ml.stop_level }
                        end
                      %>
                      <%= f.select :stop_level,
                          available_levels.map { |name, id| [name, id] },
                          { selected: ml.stop_level },
                          class: "shadow rounded-md border border-gray-200 outline-none px-2 py-1" %>
                    <% end %>
                  <% else %>
                    <%= Level.find(ml.stop_level).name %>
                  <% end %>
                </td>
                <% if @track_ages && @age_ids&.length.to_i > 1 %>
                <%
                  # Calculate the actual age range for this split's heats
                  level_heats = @heats.select { |h| h.entry.level_id >= ml.start_level && h.entry.level_id <= ml.stop_level }
                  level_age_ids = level_heats.map { |h| h.entry.age_id }.uniq.sort
                  level_min_age = level_age_ids.min || @min_age
                  level_max_age = level_age_ids.max || @max_age

                  # Use stored age range if present, otherwise use calculated range
                  display_start_age = ml.start_age || level_min_age
                  display_stop_age = ml.stop_age || level_max_age
                %>
                <td class="px-4 py-2 border">
                  <%= Age.find(display_start_age).description %>
                </td>
                <td class="px-4 py-2 border">
                  <%
                    # Can we show an age dropdown?
                    # - If has_age_range: can shrink/expand (unless it's already a single age AND is last in level group)
                    # - If no age range yet: can split if multiple ages exist and this is last in level group
                    can_show_age_dropdown = if has_age_range
                      # Non-last rows can always expand; last rows can only shrink if range > 1
                      !is_last_in_level_group || ml.start_age != ml.stop_age
                    elsif can_age_split && level_age_ids.length > 1
                      true
                    else
                      false
                    end
                  %>
                  <% if can_show_age_dropdown %>
                    <%= form_with url: split_multi_entries_path, method: :post, data: { controller: "auto-submit" } do |f| %>
                      <%= f.hidden_field :multi_level_id, value: ml.id %>
                      <%= f.hidden_field :dance, value: @dance %>
                      <%= f.hidden_field :couple, value: @couple %>
                      <%= f.hidden_field :level, value: @level %>
                      <%= f.hidden_field :age, value: @age %>
                      <%= f.hidden_field :sort, value: params[:sort] %>
                      <%
                        if has_age_range
                          if is_last_in_level_group
                            # Last row: can only shrink, show ages from start to current stop
                            available_ages = @ages.select { |desc, id| level_age_ids.include?(id) && id >= ml.start_age && id <= ml.stop_age }
                          else
                            # Non-last row: can expand to consume later splits, show ages from start to level max
                            available_ages = @ages.select { |desc, id| level_age_ids.include?(id) && id >= ml.start_age && id <= level_max_age }
                          end
                          selected_age = ml.stop_age
                        else
                          available_ages = @ages.select { |desc, id| level_age_ids.include?(id) && id >= level_min_age }
                          selected_age = level_max_age
                        end
                      %>
                      <%= f.select :stop_age,
                          available_ages.map { |desc, id| [desc, id] },
                          { selected: selected_age },
                          class: "shadow rounded-md border border-gray-200 outline-none px-2 py-1" %>
                    <% end %>
                  <% else %>
                    <%= Age.find(display_stop_age).description %>
                  <% end %>
                </td>
                <% end %>
                <% if @couple_types_present&.length.to_i > 1 %>
                <td class="px-4 py-2 border">
                  <% if ml.couple_type.present? %>
                    <%
                      # Show dropdown to allow collapsing back to "All"
                      couple_siblings = @multi_levels.select { |m|
                        m.start_level == ml.start_level && m.stop_level == ml.stop_level &&
                        m.start_age == ml.start_age && m.stop_age == ml.stop_age &&
                        m.couple_type.present?
                      }
                      # Build options: All plus the current couple types
                      couple_options = [['All', '']] + couple_siblings.map { |m| [m.couple_type, m.couple_type] }
                    %>
                    <%= form_with url: split_multi_entries_path, method: :post, data: { controller: "auto-submit" } do |f| %>
                      <%= f.hidden_field :multi_level_id, value: ml.id %>
                      <%= f.hidden_field :dance, value: @dance %>
                      <%= f.hidden_field :couple, value: @couple %>
                      <%= f.hidden_field :level, value: @level %>
                      <%= f.hidden_field :age, value: @age %>
                      <%= f.hidden_field :sort, value: params[:sort] %>
                      <%= f.select :couple_split,
                          couple_options,
                          { selected: ml.couple_type },
                          class: "shadow rounded-md border border-gray-200 outline-none px-2 py-1" %>
                    <% end %>
                  <% else %>
                    <%
                      # Only show couple split option if this is the last split without couple type
                      siblings_without_couple = @multi_levels.select { |m|
                        m.start_level == ml.start_level && m.stop_level == ml.stop_level &&
                        m.start_age == ml.start_age && m.stop_age == ml.stop_age &&
                        m.couple_type.blank?
                      }
                      can_couple_split = siblings_without_couple.length == 1
                    %>
                    <% if can_couple_split %>
                      <%= form_with url: split_multi_entries_path, method: :post, data: { controller: "auto-submit" } do |f| %>
                        <%= f.hidden_field :multi_level_id, value: ml.id %>
                        <%= f.hidden_field :dance, value: @dance %>
                        <%= f.hidden_field :couple, value: @couple %>
                        <%= f.hidden_field :level, value: @level %>
                        <%= f.hidden_field :age, value: @age %>
                        <%= f.hidden_field :sort, value: params[:sort] %>
                        <%= f.select :couple_split,
                            [['All', ''], ['Pro-Am vs Amateur', 'pro_am_vs_amateur'], ['Pro-Am / Am Lead / Am Follow', 'amateur_lead_follow']],
                            { selected: '' },
                            class: "shadow rounded-md border border-gray-200 outline-none px-2 py-1" %>
                      <% end %>
                    <% else %>
                      All
                    <% end %>
                  <% end %>
                </td>
                <% end %>
                <td class="px-4 py-2 border text-center">
                  <%= matching_heats.select { |h| h.number > 0 }.map(&:entry_id).uniq.count %>
                </td>
              </tr>
            <% end %>
          <% end %>
        </tbody>
      </table>
    </div>

    <%# Mobile card view - shown only on small screens %>
    <div class="md:hidden space-y-4 px-2">
      <% if @multi_levels.empty? %>
        <div class="border border-gray-300 rounded-lg p-4 bg-white shadow-sm">
          <div class="flex justify-between items-center mb-3">
            <span class="font-bold text-lg">All</span>
            <span class="bg-blue-100 text-blue-800 px-2 py-1 rounded text-sm">
              <%= @heats.select { |h| h.number > 0 }.map(&:entry_id).uniq.count %> couples
            </span>
          </div>
          <div class="space-y-2 text-sm">
            <div class="flex justify-between">
              <span class="text-gray-600">Level:</span>
              <span><%= Level.find(@min_level).name %> - <%= Level.find(@max_level).name %></span>
            </div>
            <% if @level_ids.length > 1 %>
            <div class="flex justify-between items-center">
              <span class="text-gray-600">Split at:</span>
              <%= form_with url: split_multi_entries_path, method: :post, data: { controller: "auto-submit" } do |f| %>
                <%= f.hidden_field :dance_id, value: @dance %>
                <%= f.hidden_field :dance, value: @dance %>
                <%= f.hidden_field :couple, value: @couple %>
                <%= f.hidden_field :level, value: @level %>
                <%= f.hidden_field :age, value: @age %>
                <%= f.hidden_field :sort, value: params[:sort] %>
                <%= f.select :stop_level,
                    @levels.select { |name, id| @level_ids.include?(id) && id >= @min_level }.map { |name, id| [name, id] },
                    { selected: @max_level },
                    class: "shadow rounded-md border border-gray-200 outline-none px-2 py-1 text-sm" %>
              <% end %>
            </div>
            <% end %>
            <% if @track_ages && @age_ids&.length.to_i > 1 %>
            <div class="flex justify-between">
              <span class="text-gray-600">Age:</span>
              <span><%= Age.find(@min_age).description %> - <%= Age.find(@max_age).description %></span>
            </div>
            <div class="flex justify-between items-center">
              <span class="text-gray-600">Split age at:</span>
              <%= form_with url: split_multi_entries_path, method: :post, data: { controller: "auto-submit" } do |f| %>
                <%= f.hidden_field :dance_id, value: @dance %>
                <%= f.hidden_field :dance, value: @dance %>
                <%= f.hidden_field :couple, value: @couple %>
                <%= f.hidden_field :level, value: @level %>
                <%= f.hidden_field :age, value: @age %>
                <%= f.hidden_field :sort, value: params[:sort] %>
                <%= f.select :stop_age,
                    @ages.select { |desc, id| @age_ids.include?(id) && id >= @min_age }.map { |desc, id| [desc, id] },
                    { selected: @max_age },
                    class: "shadow rounded-md border border-gray-200 outline-none px-2 py-1 text-sm" %>
              <% end %>
            </div>
            <% end %>
            <% if @couple_types_present&.length.to_i > 1 %>
            <div class="flex justify-between items-center">
              <span class="text-gray-600">Couple type:</span>
              <%= form_with url: split_multi_entries_path, method: :post, data: { controller: "auto-submit" } do |f| %>
                <%= f.hidden_field :dance_id, value: @dance %>
                <%= f.hidden_field :dance, value: @dance %>
                <%= f.hidden_field :couple, value: @couple %>
                <%= f.hidden_field :level, value: @level %>
                <%= f.hidden_field :age, value: @age %>
                <%= f.hidden_field :sort, value: params[:sort] %>
                <%= f.select :couple_split,
                    [['All', ''], ['Pro-Am vs Amateur', 'pro_am_vs_amateur'], ['Am Lead/Follow/Couple', 'amateur_lead_follow']],
                    { selected: '' },
                    class: "shadow rounded-md border border-gray-200 outline-none px-2 py-1 text-sm" %>
              <% end %>
            </div>
            <% end %>
          </div>
        </div>
      <% else %>
        <%
          grouped_by_level = @multi_levels.group_by { |ml| [ml.start_level, ml.stop_level] }
        %>
        <% @multi_levels.each_with_index do |ml, index| %>
          <%
            level_group = grouped_by_level[[ml.start_level, ml.stop_level]]
            is_last_in_level_group = level_group.last == ml
            has_age_range = ml.start_age.present? && ml.stop_age.present?
            can_age_split = @track_ages && @age_ids&.length.to_i > 1 && is_last_in_level_group

            matching_heats = @heats.select do |h|
              e = h.entry
              next false unless e.level_id >= ml.start_level && e.level_id <= ml.stop_level
              if ml.start_age.present? && ml.stop_age.present?
                next false unless e.age_id >= ml.start_age && e.age_id <= ml.stop_age
              end
              # Couple type matching
              if ml.couple_type.present?
                lead_type = e.lead.type
                follow_type = e.follow.type
                entry_couple_type = if lead_type == 'Student' && follow_type == 'Professional'
                  'Amateur Lead'
                elsif lead_type == 'Professional' && follow_type == 'Student'
                  'Amateur Follow'
                elsif lead_type == 'Student' && follow_type == 'Student'
                  'Amateur Couple'
                else
                  'Professional'
                end

                case ml.couple_type
                when 'Pro-Am'
                  next false unless ['Amateur Lead', 'Amateur Follow'].include?(entry_couple_type)
                when 'Amateur Couple'
                  next false unless entry_couple_type == 'Amateur Couple'
                when 'Amateur Lead'
                  next false unless entry_couple_type == 'Amateur Lead'
                when 'Amateur Follow'
                  next false unless entry_couple_type == 'Amateur Follow'
                end
              end
              true
            end

            level_siblings = @multi_levels.select { |m| m.start_level == ml.start_level && m.stop_level == ml.stop_level }
            can_level_split = level_siblings.length == 1 && (index < @multi_levels.length - 1 || ml.start_level != ml.stop_level)

            level_heats = @heats.select { |h| h.entry.level_id >= ml.start_level && h.entry.level_id <= ml.stop_level }
            level_age_ids = level_heats.map { |h| h.entry.age_id }.uniq.sort
            level_min_age = level_age_ids.min || @min_age
            level_max_age = level_age_ids.max || @max_age
            display_start_age = ml.start_age || level_min_age
            display_stop_age = ml.stop_age || level_max_age

            can_show_age_dropdown = if has_age_range
              !is_last_in_level_group || ml.start_age != ml.stop_age
            elsif can_age_split && level_age_ids.length > 1
              true
            else
              false
            end
          %>
          <div class="border border-gray-300 rounded-lg p-4 shadow-sm <%= index.even? ? 'bg-green-50' : 'bg-yellow-50' %>">
            <div class="flex justify-between items-start mb-3">
              <%= form_with url: split_multi_entries_path, method: :post, data: { controller: "auto-submit" }, class: "flex-1 mr-2" do |f| %>
                <%= f.hidden_field :multi_level_id, value: ml.id %>
                <%= f.hidden_field :dance, value: @dance %>
                <%= f.hidden_field :couple, value: @couple %>
                <%= f.hidden_field :level, value: @level %>
                <%= f.hidden_field :age, value: @age %>
                <%= f.hidden_field :sort, value: params[:sort] %>
                <%= f.text_field :name, value: ml.name,
                    class: "shadow rounded-md border border-gray-200 outline-none px-2 py-1 w-full font-bold" %>
              <% end %>
              <span class="bg-blue-100 text-blue-800 px-2 py-1 rounded text-sm whitespace-nowrap">
                <%= matching_heats.select { |h| h.number > 0 }.map(&:entry_id).uniq.count %> couples
              </span>
            </div>
            <div class="space-y-2 text-sm">
              <div class="flex justify-between items-center">
                <span class="text-gray-600">Level:</span>
                <span>
                  <%= Level.find(ml.start_level).name %>
                  <% if can_level_split %>
                    -
                    <%= form_with url: split_multi_entries_path, method: :post, data: { controller: "auto-submit" }, class: "inline" do |f| %>
                      <%= f.hidden_field :multi_level_id, value: ml.id %>
                      <%= f.hidden_field :dance, value: @dance %>
                      <%= f.hidden_field :couple, value: @couple %>
                      <%= f.hidden_field :level, value: @level %>
                      <%= f.hidden_field :age, value: @age %>
                      <%= f.hidden_field :sort, value: params[:sort] %>
                      <%
                        if index < @multi_levels.length - 1
                          available_levels = @levels.select { |name, id| @level_ids.include?(id) && id >= ml.start_level && id <= @max_level }
                        else
                          available_levels = @levels.select { |name, id| @level_ids.include?(id) && id >= ml.start_level && id <= ml.stop_level }
                        end
                      %>
                      <%= f.select :stop_level,
                          available_levels.map { |name, id| [name, id] },
                          { selected: ml.stop_level },
                          class: "shadow rounded-md border border-gray-200 outline-none px-2 py-1 text-sm" %>
                    <% end %>
                  <% elsif ml.start_level != ml.stop_level %>
                    - <%= Level.find(ml.stop_level).name %>
                  <% end %>
                </span>
              </div>
              <% if @track_ages && @age_ids&.length.to_i > 1 %>
              <div class="flex justify-between items-center">
                <span class="text-gray-600">Age:</span>
                <span>
                  <%= Age.find(display_start_age).description %>
                  <% if can_show_age_dropdown %>
                    -
                    <%= form_with url: split_multi_entries_path, method: :post, data: { controller: "auto-submit" }, class: "inline" do |f| %>
                      <%= f.hidden_field :multi_level_id, value: ml.id %>
                      <%= f.hidden_field :dance, value: @dance %>
                      <%= f.hidden_field :couple, value: @couple %>
                      <%= f.hidden_field :level, value: @level %>
                      <%= f.hidden_field :age, value: @age %>
                      <%= f.hidden_field :sort, value: params[:sort] %>
                      <%
                        if has_age_range
                          if is_last_in_level_group
                            available_ages = @ages.select { |desc, id| level_age_ids.include?(id) && id >= ml.start_age && id <= ml.stop_age }
                          else
                            available_ages = @ages.select { |desc, id| level_age_ids.include?(id) && id >= ml.start_age && id <= level_max_age }
                          end
                          selected_age = ml.stop_age
                        else
                          available_ages = @ages.select { |desc, id| level_age_ids.include?(id) && id >= level_min_age }
                          selected_age = level_max_age
                        end
                      %>
                      <%= f.select :stop_age,
                          available_ages.map { |desc, id| [desc, id] },
                          { selected: selected_age },
                          class: "shadow rounded-md border border-gray-200 outline-none px-2 py-1 text-sm" %>
                    <% end %>
                  <% elsif display_start_age != display_stop_age %>
                    - <%= Age.find(display_stop_age).description %>
                  <% end %>
                </span>
              </div>
              <% end %>
              <% if @couple_types_present&.length.to_i > 1 %>
              <div class="flex justify-between items-center">
                <span class="text-gray-600">Couple:</span>
                <% if ml.couple_type.present? %>
                  <%
                    # Show dropdown to allow collapsing back to "All"
                    couple_siblings = @multi_levels.select { |m|
                      m.start_level == ml.start_level && m.stop_level == ml.stop_level &&
                      m.start_age == ml.start_age && m.stop_age == ml.stop_age &&
                      m.couple_type.present?
                    }
                    couple_options = [['All', '']] + couple_siblings.map { |m| [m.couple_type, m.couple_type] }
                  %>
                  <%= form_with url: split_multi_entries_path, method: :post, data: { controller: "auto-submit" } do |f| %>
                    <%= f.hidden_field :multi_level_id, value: ml.id %>
                    <%= f.hidden_field :dance, value: @dance %>
                    <%= f.hidden_field :couple, value: @couple %>
                    <%= f.hidden_field :level, value: @level %>
                    <%= f.hidden_field :age, value: @age %>
                    <%= f.hidden_field :sort, value: params[:sort] %>
                    <%= f.select :couple_split,
                        couple_options,
                        { selected: ml.couple_type },
                        class: "shadow rounded-md border border-gray-200 outline-none px-2 py-1 text-sm" %>
                  <% end %>
                <% else %>
                  <%
                    siblings_without_couple = @multi_levels.select { |m|
                      m.start_level == ml.start_level && m.stop_level == ml.stop_level &&
                      m.start_age == ml.start_age && m.stop_age == ml.stop_age &&
                      m.couple_type.blank?
                    }
                    can_couple_split = siblings_without_couple.length == 1
                  %>
                  <% if can_couple_split %>
                    <%= form_with url: split_multi_entries_path, method: :post, data: { controller: "auto-submit" } do |f| %>
                      <%= f.hidden_field :multi_level_id, value: ml.id %>
                      <%= f.hidden_field :dance, value: @dance %>
                      <%= f.hidden_field :couple, value: @couple %>
                      <%= f.hidden_field :level, value: @level %>
                      <%= f.hidden_field :age, value: @age %>
                      <%= f.hidden_field :sort, value: params[:sort] %>
                      <%= f.select :couple_split,
                          [['All', ''], ['Pro-Am vs Amateur', 'pro_am_vs_amateur'], ['Am Lead/Follow/Couple', 'amateur_lead_follow']],
                          { selected: '' },
                          class: "shadow rounded-md border border-gray-200 outline-none px-2 py-1 text-sm" %>
                    <% end %>
                  <% else %>
                    <span>All</span>
                  <% end %>
                <% end %>
              </div>
              <% end %>
            </div>
          </div>
        <% end %>
      <% end %>
    </div>
  </div>
  <% end %>

  <% if @heats.any? %>
  <%
    # Helper to determine couple type for an entry
    # Returns: 'Professional', 'Amateur Lead', 'Amateur Follow', or 'Amateur Couple'
    # - Professional = Pro + Pro
    # - Amateur Lead = Pro-Am where the student is the lead
    # - Amateur Follow = Pro-Am where the student is the follow
    # - Amateur Couple = Student + Student
    get_couple_type = ->(entry) {
      lead_type = entry.lead.type
      follow_type = entry.follow.type

      if lead_type == 'Professional' && follow_type == 'Professional'
        'Professional'
      elsif lead_type == 'Student' && follow_type == 'Professional'
        'Amateur Lead'
      elsif lead_type == 'Professional' && follow_type == 'Student'
        'Amateur Follow'
      elsif lead_type == 'Student' && follow_type == 'Student'
        'Amateur Couple'
      else
        'Amateur Couple'
      end
    }

    # Helper to check if an entry matches a multi_level's criteria
    entry_matches_ml = ->(entry, ml) {
      # Check level range
      return false unless entry.level_id >= ml.start_level && entry.level_id <= ml.stop_level

      # Check age range if specified
      if ml.start_age.present? && ml.stop_age.present?
        return false unless entry.age_id >= ml.start_age && entry.age_id <= ml.stop_age
      end

      # Check couple type if specified
      if ml.couple_type.present?
        entry_couple_type = get_couple_type.call(entry)

        case ml.couple_type
        when 'Pro-Am'
          # Pro-Am matches both Amateur Lead and Amateur Follow
          return false unless ['Amateur Lead', 'Amateur Follow'].include?(entry_couple_type)
        when 'Amateur Couple'
          return false unless entry_couple_type == 'Amateur Couple'
        when 'Amateur Lead'
          return false unless entry_couple_type == 'Amateur Lead'
        when 'Amateur Follow'
          return false unless entry_couple_type == 'Amateur Follow'
        end
      end

      true
    }

    # Build tally of lead/follow appearances within each split
    # Key: split_index (or nil for no split), Value: hash of person_id => count
    split_tallies = {}
    @heats.select { |h| h.number > 0 }.each do |heat|
      entry = heat.entry
      split_index = nil
      if @is_multi && @multi_levels&.any?
        @multi_levels.each_with_index do |ml, idx|
          if entry_matches_ml.call(entry, ml)
            split_index = idx
            break
          end
        end
      end
      split_tallies[split_index] ||= Hash.new(0)
      split_tallies[split_index][entry.lead_id] += 1
      split_tallies[split_index][entry.follow_id] += 1
    end
  %>
  <table class="mx-auto">
    <thead>
      <th><%= link_to "lead", entries_path(dance: @dance, couple: @couple, level: @level, age: @age, sort: "lead"), data: { turbo: false } %>
      <th><%= link_to "follow", entries_path(dance: @dance, couple: @couple, level: @level, age: @age, sort: "follow"), data: { turbo: false } %>
      <% unless @dance_name %>
      <th><%= link_to "dance", entries_path(dance: @dance, couple: @couple, level: @level, age: @age, sort: "dance"), data: { turbo: false } %>
      <% end %>
      <th><%= link_to "level", entries_path(dance: @dance, couple: @couple, level: @level, age: @age, sort: "level"), data: { turbo: false } %>
      <% if @track_ages %>
      <th><%= link_to "age", entries_path(dance: @dance, couple: @couple, level: @level, age: @age, sort: "age"), data: { turbo: false } %>
      <% end %>
    </thead>

    <tbody>
      <% @heats.each do |heat| %>
        <% entry = heat.entry %>
        <%
          # Determine which split this heat belongs to
          split_index = nil
          if @is_multi && @multi_levels&.any?
            @multi_levels.each_with_index do |ml, idx|
              if entry_matches_ml.call(entry, ml)
                split_index = idx
                break
              end
            end
          end

          # Get the tally for this split
          tally = @is_multi ? (split_tallies[split_index] || {}) : {}

          # Build CSS classes
          row_classes = ["group"]
          if heat.number < 0
            row_classes << "line-through opacity-50"
          end
          if split_index
            row_classes << (split_index.even? ? "bg-green-50" : "bg-yellow-50")
          end

          # Determine if lead/follow appear multiple times in this split
          lead_duplicate = entry.lead_id > 0 && (tally[entry.lead_id] || 0) > 1
          follow_duplicate = entry.follow_id > 0 && (tally[entry.follow_id] || 0) > 1
        %>
        <tr class="<%= row_classes.join(' ') %>">
          <td class="row <%= lead_duplicate ? 'text-white bg-red-600' : '' %>"><%= link_to entry.lead.display_name, entry.lead %>
          <td class="row <%= follow_duplicate ? 'text-white bg-red-600' : '' %>"><%= link_to entry.follow.display_name, entry.follow %>
          <% unless @dance_name %>
          <td class="row"><%= link_to heat.dance.name, heat.dance %>
          <% end %>
          <td class="row"><%= entry.level_name %>
          <% if @track_ages %>
          <td class="row"><%= entry.age.description %>
          <% end %>
          <td>
          <form method="get" action="<%= edit_heat_path(heat) %>">
          <button type="submit" class='group-hover:inline hidden x-2 rounded-lg py-1 px-2 text-white bg-blue-600 font-medium'>Edit</button>
          </form>
          </td>
        </tr>
      <% end %>
    </tbody>
  </table>
  <% end %>

</div>
